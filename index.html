<head>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect" />
    <link as="style"
          href="https://fonts.googleapis.com/css2?display=swap&amp;family=Manrope%3Awght%40400%3B500%3B700%3B800&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900"
          onload="this.rel='stylesheet'" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>MiPréstamo - Gestión de Préstamos</title>
    <link href="data:image/x-icon;base64," rel="icon" type="image/x-icon" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style>
        /* Optimizaciones para móvil */
        * {
          -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
          -webkit-touch-callout: none;
          -webkit-user-select: none;
          -moz-user-select: none;
          -ms-user-select: none;
          user-select: none;
        }

        body {
          min-height: 100vh;
          min-height: -webkit-fill-available;
          font-size: 16px;
          overscroll-behavior-y: none;
        }

        .touch-target {
          min-height: 44px;
          min-width: 44px;
        }

        .tap-highlight {
          transition: all 0.1s ease;
        }

        .tap-highlight:active {
          transform: scale(0.95);
          opacity: 0.8;
        }

        .slide-up {
          animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
          from {
            opacity: 0;
            transform: translateY(20px);
          }

          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        .smooth-scroll {
          scroll-behavior: smooth;
          -webkit-overflow-scrolling: touch;
        }

        .safe-area-top {
          padding-top: env(safe-area-inset-top);
        }

        .safe-area-bottom {
          padding-bottom: env(safe-area-inset-bottom);
        }

        @keyframes pulse {
          0% {
            transform: scale(1);
          }

          50% {
            transform: scale(1.05);
          }

          100% {
            transform: scale(1);
          }
        }

        .pulse-feedback {
          animation: pulse 0.15s ease-in-out;
        }

        .mobile-card {
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
          border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .mobile-text-lg {
          font-size: 18px;
          line-height: 1.4;
        }

        .mobile-text-xl {
          font-size: 24px;
          line-height: 1.3;
        }

        /* Modal styles */
        .modal-overlay {
          backdrop-filter: blur(4px);
        }

        .form-input {
          transition: all 0.3s ease;
        }

        .form-input:focus {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .slide-in-up {
          animation: slideInUp 0.4s ease-out;
        }

        @keyframes slideInUp {
          from {
            opacity: 0;
            transform: translateY(100%);
          }

          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        /* Lista de clientes */
        .client-item {
          transition: all 0.2s ease;
        }

        .client-item:hover {
          background-color: #f8fafc;
          transform: translateY(-1px);
        }

        .payment-status {
          animation: statusPulse 2s infinite;
        }

        @keyframes statusPulse {

          0%,
          100% {
            opacity: 1;
          }

          50% {
            opacity: 0.7;
          }
        }

        /* Long press effect */
        .long-press {
          background-color: #fee2e2 !important;
          transform: scale(0.98);
          transition: all 0.2s ease;
        }

        .delete-confirm {
          animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {

          0%,
          100% {
            transform: translateX(0);
          }

          25% {
            transform: translateX(-5px);
          }

          75% {
            transform: translateX(5px);
          }
        }

        /* Modal de login y configuración */
        .login-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          z-index: 9999;
          display: flex;
          align-items: center;
          justify-content: center;
          backdrop-filter: blur(10px);
        }

        .login-card {
          background: white;
          border-radius: 20px;
          padding: 2rem;
          box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
          max-width: 400px;
          width: 90%;
          text-align: center;
          transform: scale(0.9);
          animation: scaleIn 0.3s ease-out forwards;
        }

        @keyframes scaleIn {
          to {
            transform: scale(1);
          }
        }

        .login-input {
          width: 100%;
          padding: 1rem;
          border: 2px solid #e2e8f0;
          border-radius: 12px;
          font-size: 16px;
          margin: 0.5rem 0;
          transition: all 0.3s ease;
        }

        .login-input:focus {
          outline: none;
          border-color: #3b82f6;
          box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .login-btn {
          width: 100%;
          padding: 1rem;
          background: linear-gradient(135deg, #3b82f6, #1d4ed8);
          color: white;
          border: none;
          border-radius: 12px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          margin-top: 1rem;
        }

        .login-btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }

        .login-btn:active {
          transform: translateY(0);
        }

        .error-message {
          color: #ef4444;
          font-size: 14px;
          margin-top: 0.5rem;
          display: none;
        }
    </style>
</head>

<body class="bg-gray-50 safe-area-top safe-area-bottom">
<div class="flex flex-col min-h-screen w-full max-w-md mx-auto bg-white shadow-xl smooth-scroll"
     style='font-family: Manrope, "Noto Sans", sans-serif;'>

    <!-- Header con Status Bar -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white sticky top-0 z-40 safe-area-top">
        <div class="flex items-center justify-between p-4 pb-3">
            <button onclick="toggleMenu()"
                    class="touch-target flex items-center justify-center rounded-full bg-white bg-opacity-20 tap-highlight">
                <span class="material-symbols-outlined text-white">assessment</span>
            </button>

            <div class="text-center flex-1">
                <h1 class="text-lg font-bold">Juan Villarreal</h1>
                <p class="text-blue-100 text-xs" id="currentDate">Hoy, 14 Sept</p>
            </div>

            <button onclick="resetLenderConfig()"
                    class="touch-target flex items-center justify-center rounded-full bg-white bg-opacity-20 tap-highlight">
                <span class="material-symbols-outlined text-white">settings_backup_restore</span>
            </button>
        </div>
    </div>
    <!-- Resumen Principal - Cards Grandes -->

    <div class="px-4 pt-4">
        <div
                class="mobile-card bg-gradient-to-br from-green-500 to-green-600 rounded-2xl p-5 text-white mb-4 tap-highlight slide-up">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-green-100 text-sm font-medium mb-1">Capital Recuperado</p>
                    <p id="totalBalance" class="text-white mobile-text-xl font-bold mb-2">$0</p>
                    <div class="flex items-center">
                        <span class="material-symbols-outlined text-green-200 text-lg mr-1">trending_up</span>
                        <span id="balanceChange" class="text-green-100 text-sm">Sin cambios</span>
                    </div>
                </div>
                <div class="bg-white bg-opacity-20 rounded-full p-3">
                    <span class="material-symbols-outlined text-white text-2xl">account_balance_wallet</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Métricas Rápidas - Grid 2x2 -->
    <div class="px-4">
        <div class="grid grid-cols-2 gap-3 mb-4">
            <div class="mobile-card bg-white rounded-xl p-4 tap-highlight">
                <div class="flex items-center justify-between mb-2">
                    <span class="material-symbols-outlined text-blue-600">trending_up</span>
                    <span id="totalPercentage" class="text-green-600 text-xs font-medium">0%</span>
                </div>
                <p class="text-gray-500 text-sm mb-1">Total Prestado</p>
                <p id="totalLoaned" class="text-gray-900 mobile-text-lg font-bold">$0</p>
            </div>

            <div class="mobile-card bg-white rounded-xl p-4 tap-highlight">
                <div class="flex items-center justify-between mb-2">
                    <span class="material-symbols-outlined text-orange-600">schedule</span>
                    <span id="pendingCount" class="text-orange-600 text-xs font-medium">0</span>
                </div>
                <p class="text-gray-500 text-sm mb-1">Pendiente</p>
                <p id="totalPending" class="text-gray-900 mobile-text-lg font-bold">$0</p>
            </div>

            <div class="mobile-card bg-white rounded-xl p-4 tap-highlight">
                <div class="flex items-center justify-between mb-2">
                    <span class="material-symbols-outlined text-green-600">payments</span>
                    <span id="paymentsToday" class="text-green-600 text-xs font-medium">0 pagos</span>
                </div>
                <p class="text-gray-500 text-sm mb-1">Cobrado Hoy</p>
                <p id="collectedToday" class="text-gray-900 mobile-text-lg font-bold">$0</p>
            </div>

            <div class="mobile-card bg-white rounded-xl p-4 tap-highlight">
                <div class="flex items-center justify-between mb-2">
                    <span class="material-symbols-outlined text-green-600">trending_up</span>
                    <span id="interestCount" class="text-green-600 text-xs font-medium">0 pagos</span>
                </div>
                <p class="text-gray-500 text-sm mb-1">% Cobrados</p>
                <p id="interestAmount" class="text-gray-900 mobile-text-lg font-bold">$0</p>
            </div>
        </div>
    </div>
    <!-- Acciones Principales - Botones Grandes -->
    <div class="px-4 mb-4">
        <h2 class="text-gray-900 font-bold mobile-text-lg mb-3">Acciones Rápidas</h2>
        <div class="space-y-3">
            <button onclick="openNewLoanModal()"
                    class="w-full mobile-card bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl p-4 flex items-center justify-between tap-highlight">
                <div class="flex items-center">
                    <div class="bg-white bg-opacity-20 rounded-full p-2 mr-3">
                        <span class="material-symbols-outlined text-xl">add_circle</span>
                    </div>
                    <div class="text-left">
                        <p class="font-semibold">Nuevo Préstamo</p>
                        <p class="text-blue-100 text-sm">Crear préstamo rápido</p>
                    </div>
                </div>
                <span class="material-symbols-outlined">chevron_right</span>
            </button>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="openClientsModal()"
                        class="mobile-card bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl p-4 flex flex-col items-center tap-highlight">
                    <span class="material-symbols-outlined text-2xl mb-2">group</span>
                    <span class="font-semibold text-sm">Ver Clientes</span>
                </button>

                <button onclick="openInfoModal()"
                        class="mobile-card bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl p-4 flex flex-col items-center tap-highlight">
                    <span class="material-symbols-outlined text-2xl mb-2">info</span>
                    <span class="font-semibold text-sm">Información</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Lista de Actividad Reciente -->
    <div class="px-4 flex-1">
        <div class="flex justify-between items-center mb-3">
            <h2 class="text-gray-900 font-bold mobile-text-lg">Actividad Reciente</h2>

        </div>

        <div id="activityList" class="space-y-2 pb-6">
            <!-- Actividad se carga dinámicamente -->
            <div class="text-center text-gray-500 py-8">
                <span class="material-symbols-outlined text-4xl mb-2 block">receipt_long</span>
                <p class="text-sm">No hay actividad reciente</p>
                <p class="text-xs text-gray-400">Crea tu primer préstamo para comenzar</p>
            </div>
        </div>
    </div>

</div>

<!-- Bottom Navigation -->
<div class="sticky bottom-0 bg-white border-t border-gray-200 safe-area-bottom">
    <div class="flex justify-around py-2">
        <button class="flex flex-col items-center touch-target tap-highlight text-blue-600"
                onclick="setActiveTab('dashboard')">
            <span class="material-symbols-outlined text-2xl">dashboard</span>
            <span class="text-xs font-medium mt-1">Panel</span>
        </button>

        <button class="flex flex-col items-center touch-target tap-highlight text-gray-500" onclick="openClientsModal()">
            <span class="material-symbols-outlined text-2xl">group</span>
            <span class="text-xs font-medium mt-1">Clientes</span>
        </button>

        <button class="flex flex-col items-center touch-target tap-highlight text-gray-500 relative"
                onclick="openNewLoanModal()">
            <div class="bg-blue-600 rounded-full p-2">
                <span class="material-symbols-outlined text-white text-2xl">add</span>
            </div>
            <span class="text-xs font-medium mt-1">Nuevo</span>
        </button>

        <button class="flex flex-col items-center touch-target tap-highlight text-gray-500" onclick="openInfoModal()">
            <span class="material-symbols-outlined text-2xl">info</span>
            <span class="text-xs font-medium mt-1">Info</span>
        </button>

        <button class="flex flex-col items-center touch-target tap-highlight text-gray-500" onclick="toggleMenu()">
            <span class="material-symbols-outlined text-2xl">more_horiz</span>
            <span class="text-xs font-medium mt-1">Report</span>
        </button>
    </div>
</div>

<!-- Modal Nuevo Préstamo -->
<div id="newLoanModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden modal-overlay"
     onclick="closeNewLoanModal()">
    <div class="fixed bottom-0 left-0 right-0 bg-white rounded-t-2xl max-h-[90vh] slide-in-up"
         onclick="event.stopPropagation()">
        <div class="p-4">
            <!-- Handle bar -->
            <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>

            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-gray-900 mobile-text-lg">Nuevo Préstamo</h3>
                <button onclick="closeNewLoanModal()" class="touch-target text-gray-500 tap-highlight">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="max-h-[70vh] overflow-y-auto smooth-scroll space-y-4">
                <!-- Datos del Cliente -->
                <div class="space-y-3">
                    <h4 class="font-semibold text-gray-800 flex items-center">
                        <span class="material-symbols-outlined text-blue-600 mr-2">person</span>
                        Datos del Cliente
                    </h4>

                    <div class="space-y-3">
                        <input type="text" id="clientName" placeholder="Nombre completo"
                               class="form-input w-full p-4 border border-gray-300 rounded-xl text-base bg-gray-50 focus:bg-white focus:border-blue-500 focus:outline-none">

                        <input type="tel" id="clientPhone" placeholder="Teléfono"
                               class="form-input w-full p-4 border border-gray-300 rounded-xl text-base bg-gray-50 focus:bg-white focus:border-blue-500 focus:outline-none">

                        <input type="text" id="clientId" placeholder="Cédula / ID"
                               class="form-input w-full p-4 border border-gray-300 rounded-xl text-base bg-gray-50 focus:bg-white focus:border-blue-500 focus:outline-none">

                        <textarea id="clientAddress" placeholder="Dirección completa" rows="2"
                                  class="form-input w-full p-4 border border-gray-300 rounded-xl text-base bg-gray-50 focus:bg-white focus:border-blue-500 focus:outline-none resize-none"></textarea>
                    </div>
                </div>

                <!-- Datos del Préstamo -->
                <div class="space-y-3">
                    <h4 class="font-semibold text-gray-800 flex items-center">
                        <span class="material-symbols-outlined text-green-600 mr-2">payments</span>
                        Datos del Préstamo
                    </h4>

                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" id="loanAmount" placeholder="Monto ($)"
                               class="form-input w-full p-4 border border-gray-300 rounded-xl text-base bg-gray-50 focus:bg-white focus:border-blue-500 focus:outline-none">

                        <input type="number" id="interestRate" placeholder="Interés (%)" step="0.1"
                               class="form-input w-full p-4 border border-gray-300 rounded-xl text-base bg-gray-50 focus:bg-white focus:border-blue-500 focus:outline-none">
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" id="loanTerm" placeholder="Plazo (días)"
                               class="form-input w-full p-4 border border-gray-300 rounded-xl text-base bg-gray-50 focus:bg-white focus:border-blue-500 focus:outline-none">

                        <select id="paymentFreq"
                                class="form-input w-full p-4 border border-gray-300 rounded-xl text-base bg-gray-50 focus:bg-white focus:border-blue-500 focus:outline-none">
                            <option value="">Frecuencia</option>
                            <option value="diario">Diario</option>
                            <option value="semanal">Semanal</option>
                            <option value="quincenal">Quincenal</option>
                            <option value="mensual">Mensual</option>
                        </select>
                    </div>

                    <input type="date" id="loanDate"
                           class="form-input w-full p-4 border border-gray-300 rounded-xl text-base bg-gray-50 focus:bg-white focus:border-blue-500 focus:outline-none">
                </div>

                <!-- Cálculo Automático -->
                <div id="loanCalculation" class="bg-blue-50 rounded-xl p-4 border-l-4 border-blue-400">
                    <h4 class="font-semibold text-blue-800 mb-2">Resumen del Préstamo</h4>
                    <div class="space-y-1 text-sm">
                        <div class="flex justify-between">
                            <span class="text-blue-700">Monto prestado:</span>
                            <span id="calcAmount" class="font-semibold text-blue-900">$0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-blue-700">Total a cobrar:</span>
                            <span id="calcTotal" class="font-semibold text-blue-900">$0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-blue-700">Cuota por pago:</span>
                            <span id="calcPayment" class="font-semibold text-blue-900">$0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-blue-700">Fecha vencimiento:</span>
                            <span id="calcDueDate" class="font-semibold text-blue-900">--</span>
                        </div>
                    </div>
                </div>

                <!-- Observaciones -->
                <div class="space-y-3">
                    <h4 class="font-semibold text-gray-800 flex items-center">
                        <span class="material-symbols-outlined text-orange-600 mr-2">note</span>
                        Observaciones
                    </h4>

                    <textarea id="loanNotes" placeholder="Notas adicionales, garantías, referencias, etc." rows="3"
                              class="form-input w-full p-4 border border-gray-300 rounded-xl text-base bg-gray-50 focus:bg-white focus:border-blue-500 focus:outline-none resize-none"></textarea>
                </div>

                <!-- Botones de Acción -->
                <div class="flex gap-3 pt-4 pb-2">
                    <button onclick="closeNewLoanModal()"
                            class="flex-1 p-4 border border-gray-300 rounded-xl text-gray-700 font-semibold tap-highlight">
                        Cancelar
                    </button>
                    <button onclick="saveLoan()"
                            class="flex-1 p-4 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl font-semibold tap-highlight">
                        Crear Préstamo
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Lista de Clientes -->
<div id="clientsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden modal-overlay"
     onclick="closeClientsModal()">
    <div class="fixed bottom-0 left-0 right-0 bg-white rounded-t-2xl max-h-[90vh] slide-in-up"
         onclick="event.stopPropagation()">
        <div class="p-4">
            <!-- Handle bar -->
            <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>

            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-gray-900 mobile-text-lg">Mis Clientes</h3>
                <button onclick="closeClientsModal()" class="touch-target text-gray-500 tap-highlight">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Buscador -->
            <div class="mb-4">
                <input type="text" id="clientSearch" placeholder="Buscar cliente..."
                       class="w-full p-3 border border-gray-300 rounded-xl text-base bg-gray-50 focus:bg-white focus:border-blue-500 focus:outline-none"
                       oninput="filterClients()">
            </div>

            <!-- Lista de clientes -->
            <div id="clientsList" class="max-h-[60vh] overflow-y-auto smooth-scroll space-y-2">
                <!-- Los clientes se cargan dinámicamente -->
                <div class="text-center text-gray-500 py-8">
                    <span class="material-symbols-outlined text-4xl mb-2 block">group</span>
                    <p class="text-sm">No hay clientes registrados</p>
                    <p class="text-xs text-gray-400">Crea tu primer préstamo para agregar clientes</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Detalle de Cliente -->
<div id="clientDetailModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden modal-overlay"
     onclick="closeClientDetailModal()">
    <div class="fixed bottom-0 left-0 right-0 bg-white rounded-t-2xl max-h-[90vh] slide-in-up"
         onclick="event.stopPropagation()">
        <div class="p-4">
            <!-- Handle bar -->
            <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>

            <div class="flex justify-between items-center mb-4">
                <h3 id="clientDetailName" class="font-bold text-gray-900 mobile-text-lg">Cliente</h3>
                <button onclick="closeClientDetailModal()" class="touch-target text-gray-500 tap-highlight">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Info del Cliente -->
            <div class="bg-blue-50 rounded-xl p-4 mb-4">
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-blue-700">Teléfono:</span>
                        <span id="clientDetailPhone" class="font-semibold text-blue-900">--</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-blue-700">Cédula:</span>
                        <span id="clientDetailId" class="font-semibold text-blue-900">--</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-blue-700">Fecha del Préstamo:</span>
                        <span id="loanCreationDate" class="font-semibold text-blue-900">--</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-blue-700">Monto Original:</span>
                        <span id="originalAmount" class="font-semibold text-blue-900">$0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-blue-700">Deuda Actual:</span>
                        <span id="clientDebtTotal" class="font-semibold text-red-600">$0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-blue-700">Cuota (<span id="paymentFreqText">--</span>):</span>
                        <span id="paymentAmountText" class="font-semibold text-orange-600">$0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-blue-700">Estado:</span>
                        <span id="clientStatus" class="font-semibold text-green-600">Al día</span>
                    </div>
                </div>
            </div>


            <!-- Botones de Acción -->
            <div class="grid grid-cols-2 gap-3 mb-4">
                <button onclick="openPaymentModal()"
                        class="p-3 bg-green-600 text-white rounded-xl font-semibold tap-highlight flex items-center justify-center">
                    <span class="material-symbols-outlined mr-2">add</span>
                    Agregar Pago
                </button>
                <button onclick="generateReceipt()"
                        class="p-3 bg-blue-600 text-white rounded-xl font-semibold tap-highlight flex items-center justify-center">
                    <span class="material-symbols-outlined mr-2">receipt</span>
                    Recibo
                </button>
            </div>

            <!-- Historial de Pagos -->
            <div class="mb-6">
                <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                    <span class="material-symbols-outlined text-green-600 mr-2">history</span>
                    Historial de Pagos
                </h4>
                <div id="paymentHistory" class="max-h-[32vh] overflow-y-auto smooth-scroll space-y-2 pb-6">
                    <!-- Historial se carga dinámicamente -->
                </div>
            </div>
            <!-- Modal Agregar Pago -->
            <div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden modal-overlay"
                 onclick="closePaymentModal()">
                <div class="fixed bottom-0 left-0 right-0 bg-white rounded-t-2xl max-h-[85vh] slide-in-up"
                     onclick="event.stopPropagation()">
                    <div class="p-4">
                        <!-- Handle bar -->
                        <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>

                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-gray-900 mobile-text-lg">Registrar Pago</h3>
                            <button onclick="closePaymentModal()" class="touch-target text-gray-500 tap-highlight">
                                <span class="material-symbols-outlined">close</span>
                            </button>
                        </div>



                        <div class="max-h-[65vh] overflow-y-auto smooth-scroll space-y-4"></div>
                        <!-- Cliente Info -->
                        <div class="bg-gray-50 rounded-xl p-3">
                            <p class="text-sm text-gray-600">Cliente:</p>
                            <p id="paymentClientName" class="font-semibold text-gray-900">--</p>
                        </div>

                        <!-- Monto del Pago -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Monto del Pago</label>
                            <input type="number" id="paymentAmount" placeholder="Ej: 500"
                                   class="form-input w-full p-4 border border-gray-300 rounded-xl text-base bg-gray-50 focus:bg-white focus:border-green-500 focus:outline-none">
                        </div>

                        <!-- Tipo de Pago -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Pago</label>
                            <select id="paymentType"
                                    class="form-input w-full p-4 border border-gray-300 rounded-xl text-base bg-gray-50 focus:bg-white focus:border-green-500 focus:outline-none"
                                    onchange="updatePaymentSummary()">
                                <option value="interes">Pago de Interés</option>
                                <option value="capital">Pago a Capital</option>
                            </select>
                        </div>

                        <!-- Método de Pago -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Método de Pago</label>
                            <select id="paymentMethod"
                                    class="form-input w-full p-4 border border-gray-300 rounded-xl text-base bg-gray-50 focus:bg-white focus:border-green-500 focus:outline-none">
                                <option value="efectivo">Efectivo</option>
                                <option value="transferencia">Transferencia</option>
                                <option value="deposito">Depósito</option>
                                <option value="cheque">Cheque</option>
                            </select>
                        </div>

                        <!-- Notas -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Notas (Opcional)</label>
                            <textarea id="paymentNotes" placeholder="Observaciones del pago..." rows="2"
                                      class="form-input w-full p-4 border border-gray-300 rounded-xl text-base bg-gray-50 focus:bg-white focus:border-green-500 focus:outline-none resize-none"></textarea>
                        </div>

                        <!-- Resumen -->
                        <div id="paymentSummary" class="bg-green-50 rounded-xl p-4 border-l-4 border-green-400">
                            <h4 class="font-semibold text-green-800 mb-2">Resumen del Pago</h4>
                            <div class="space-y-1 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-green-700">Monto a pagar:</span>
                                    <span id="summaryAmount" class="font-semibold text-green-900">$0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-green-700">Deuda restante:</span>
                                    <span id="summaryRemaining" class="font-semibold text-green-900">$0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Botones fijos en la parte inferior -->
                        <div class="sticky bottom-0 bg-white border-t border-gray-100 p-4">
                            <div class="flex gap-3">
                                <button onclick="closePaymentModal()"
                                        class="flex-1 p-4 border border-gray-300 rounded-xl text-gray-700 font-semibold tap-highlight">
                                    Cancelar
                                </button>
                                <button onclick="savePayment()"
                                        class="flex-1 p-4 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-xl font-semibold tap-highlight">
                                    Registrar Pago
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Información -->
<div id="infoModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden modal-overlay" onclick="closeInfoModal()">
    <div class="fixed bottom-0 left-0 right-0 bg-white rounded-t-2xl max-h-[90vh] slide-in-up flex flex-col"
         onclick="event.stopPropagation()">

        <!-- Header fijo -->
        <div class="p-4 flex-shrink-0">
            <!-- Handle bar -->
            <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>

            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-gray-900 mobile-text-lg">Información General</h3>
                <button onclick="closeInfoModal()" class="touch-target text-gray-500 tap-highlight">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
        </div>

        <!-- Contenido con scroll -->
        <div class="flex-1 overflow-y-auto px-4 pb-4 smooth-scroll">
            <!-- Préstamos por Frecuencia -->
            <div class="mb-6">
                <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                    <span class="material-symbols-outlined text-blue-600 mr-2">schedule</span>
                    Préstamos por Frecuencia de Pago
                </h4>

                <div class="space-y-3">
                    <div id="dailyInfo" class="bg-red-50 rounded-xl p-4 border-l-4 border-red-400">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-red-800 font-semibold">Pago Diario</p>
                                <p class="text-red-600 text-sm">Préstamos activos</p>
                            </div>
                            <div class="text-right">
                                <p class="text-red-900 font-bold text-xl">0</p>
                                <p class="text-red-700 text-sm">préstamos</p>
                            </div>
                        </div>
                    </div>

                    <div id="weeklyInfo" class="bg-orange-50 rounded-xl p-4 border-l-4 border-orange-400">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-orange-800 font-semibold">Pago Semanal</p>
                                <p class="text-orange-600 text-sm">Préstamos activos</p>
                            </div>
                            <div class="text-right">
                                <p class="text-orange-900 font-bold text-xl">0</p>
                                <p class="text-orange-700 text-sm">préstamos</p>
                            </div>
                        </div>
                    </div>

                    <div id="biweeklyInfo" class="bg-purple-50 rounded-xl p-4 border-l-4 border-purple-400">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-purple-800 font-semibold">Pago Quincenal</p>
                                <p class="text-purple-600 text-sm">Préstamos activos</p>
                            </div>
                            <div class="text-right">
                                <p class="text-purple-900 font-bold text-xl">1</p>
                                <p class="text-purple-700 text-sm">préstamos</p>
                            </div>
                        </div>
                    </div>

                    <div id="monthlyInfo" class="bg-blue-50 rounded-xl p-4 border-l-4 border-blue-400">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-blue-800 font-semibold">Pago Mensual</p>
                                <p class="text-blue-600 text-sm">Préstamos activos</p>
                            </div>
                            <div class="text-right">
                                <p class="text-blue-900 font-bold text-xl">0</p>
                                <p class="text-blue-700 text-sm">préstamos</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tasas de Interés -->
            <div class="mb-6">
                <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                    <span class="material-symbols-outlined text-green-600 mr-2">percent</span>
                    Tasas de Interés Aplicadas
                </h4>

                <div id="interestRatesList" class="space-y-2">
                    <!-- Se carga dinámicamente -->
                </div>
            </div>

            <!-- Estadísticas Generales -->
            <div class="bg-gray-50 rounded-xl p-4 mb-4">
                <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                    <span class="material-symbols-outlined text-gray-600 mr-2">analytics</span>
                    Estadísticas Generales
                </h4>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="text-center">
                        <p class="text-gray-600">Total Préstamos</p>
                        <p id="totalLoansCount" class="font-bold text-2xl text-gray-900">0</p>
                    </div>
                    <div class="text-center">
                        <p class="text-gray-600">Préstamos Activos</p>
                        <p id="activeLoansInfo" class="font-bold text-2xl text-green-600">0</p>
                    </div>
                    <div class="text-center">
                        <p class="text-gray-600">Préstamos Pagados</p>
                        <p id="completedLoansInfo" class="font-bold text-2xl text-blue-600">0</p>
                    </div>
                    <div class="text-center">
                        <p class="text-gray-600">Tasa Promedio</p>
                        <p id="averageRateInfo" class="font-bold text-2xl text-purple-600">0%</p>
                    </div>
                </div>
            </div>
        </div> <!-- Cierre del contenido con scroll -->
    </div>
</div>


</body>
<!-- Modal de Login -->
<div id="loginModal" class="login-overlay">
    <div class="login-card">
        <div class="mb-6">
            <span class="material-symbols-outlined text-6xl text-blue-600 mb-4 block">lock</span>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Acceso Seguro</h2>
            <p class="text-gray-600">Ingresa el código de acceso</p>
        </div>

        <input type="password" id="accessCode" class="login-input" placeholder="Código de acceso" maxlength="10">

        <div id="loginError" class="error-message">
            Código incorrecto. Inténtalo de nuevo.
        </div>

        <button onclick="validateAccess()" class="login-btn">
            Ingresar
        </button>

        <p class="text-xs text-gray-500 mt-4">
            Sistema de gestión de préstamos seguro
        </p>
    </div>
</div>

<!-- Modal de Configuración Inicial -->
<div id="setupModal" class="login-overlay" style="display: none;">
    <div class="login-card">
        <div class="mb-6">
            <span class="material-symbols-outlined text-6xl text-green-600 mb-4 block">person_add</span>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Configuración Inicial</h2>
            <p class="text-gray-600">Configura tu información de prestamista</p>
        </div>

        <input type="text" id="lenderName" class="login-input" placeholder="Tu nombre completo" maxlength="50">

        <input type="tel" id="lenderPhone" class="login-input" placeholder="Tu teléfono (opcional)" maxlength="15">

        <div id="setupError" class="error-message">
            Por favor ingresa al menos tu nombre.
        </div>

        <button onclick="saveLenderConfig()" class="login-btn">
            Guardar Configuración
        </button>
    </div>
</div>


<script>
    // Variables globales
    let currentLoanData = {};
    let currentClientId = null;
    let loans = [];
    let payments = [];

    // Función para verificar conexión a internet
    async function verificarConexion() {
      try {
        // Intentar hacer una petición simple a Google
        const response = await fetch('https://www.google.com/favicon.ico', {
          method: 'HEAD',
          mode: 'no-cors',
          cache: 'no-cache'
        });
        return true;
      } catch (error) {
        return false;
      }
    }

    // URLs de los formularios de Google
    const FORM_PRESTAMOS_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSfadBxrR-tVJUXp6BR5Nn2310qlni_8JAgUxfgq2MXqvMelqQ/formResponse';
    const FORM_PAGOS_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSeOsYlCX2qZxDXDq-d8Tv1Uz0rlHdFuVevgZw_wgMJcjSF34w/formResponse';

    // IDs de los campos del formulario de préstamos
    const FORM_PRESTAMOS_FIELDS = {
      fechaHora: 'entry.1651377936',
      nombreCliente: 'entry.145913916',
      cedula: 'entry.141493025',
      telefono: 'entry.2108939877',
      direccion: 'entry.1776782030',
      montoPrestado: 'entry.212740916',
      tasaInteres: 'entry.1719647988',
      plazo: 'entry.192436622',
      frecuencia: 'entry.146430448',
      fechaPrestamo: 'entry.63445070',
      interesPeriodo: 'entry.2070474332',
      observaciones: 'entry.1417439209',
      idPrestamo: 'entry.1648872212'
    };

    // IDs de los campos del formulario de pagos
    const FORM_PAGOS_FIELDS = {
      fechaHora: 'entry.1919147352',
      nombreCliente: 'entry.59761809',
      idPrestamo: 'entry.1013050783',
      montoPago: 'entry.2040182684',
      tipoPago: 'entry.845974957',
      metodoPago: 'entry.1462362618',
      notas: 'entry.900731209',
      saldoRestante: 'entry.2113039200',
      idPago: 'entry.142917775'
    };

    // Variables para long press
    let longPressTimer = null;
    let isLongPress = false;


    // Inicialización al cargar la página
    document.addEventListener('DOMContentLoaded', function () {
      // VERIFICAR SI YA FUE VALIDADO ANTERIORMENTE
      const alreadyValidated = isAccessAlreadyValidated();
      const lenderConfig = getLenderConfig();

      if (alreadyValidated && lenderConfig.name) {
        // Ya fue validado Y configurado - IR DIRECTO A LA APP
        document.getElementById('loginModal').style.display = 'none';
        updateLenderDisplay();
        initializeApp();
        setTimeout(() => {
          refreshAllData();
        }, 100);
      } else if (alreadyValidated && !lenderConfig.name) {
        // Ya fue validado pero NO configurado - IR A CONFIGURACIÓN
        document.getElementById('loginModal').style.display = 'none';
        showSetupModal();
      } else {
        // PRIMERA VEZ - MOSTRAR LOGIN
        if (lenderConfig.name) {
          updateLenderDisplay();
        }

        setupEventListeners();

        // Focus en el campo de código
        setTimeout(() => {
          document.getElementById('accessCode').focus();
        }, 500);
      }

      // Auto-verificación de datos al cargar
      setTimeout(() => {
        if (isAppInitialized) {
          refreshAllData();
        }
      }, 200);
    });
    // Código de acceso único (cámbialo por el que quieras)
    const ACCESS_CODE = "12345";

    // Variables para configuración
    let isAppInitialized = false;

    // Función para validar acceso
    function validateAccess() {
      const inputCode = document.getElementById('accessCode').value.trim().toUpperCase();
      const errorDiv = document.getElementById('loginError');

      if (inputCode === ACCESS_CODE) {
        // Código correcto - GUARDAR QUE YA FUE VALIDADO
        errorDiv.style.display = 'none';
        localStorage.setItem('accessValidated', 'true');

        // Verificar si ya está configurado
        const lenderConfig = getLenderConfig();

        if (lenderConfig.name) {
          // Ya está configurado, ir directo a la app
          closeLoginModal();
          initializeApp();
          // Forzar actualización inmediata
          setTimeout(() => {
            refreshAllData();
          }, 500);
        } else {
          // Mostrar modal de configuración
          showSetupModal();
        }
      } else {
        // Código incorrecto
        errorDiv.style.display = 'block';
        document.getElementById('accessCode').value = '';

        // Efecto de vibración (si el dispositivo lo soporta)
        if (navigator.vibrate) {
          navigator.vibrate(200);
        }

        // Efecto visual de error
        const card = document.querySelector('.login-card');
        card.style.animation = 'shake 0.5s ease-in-out';
        setTimeout(() => {
          card.style.animation = '';
        }, 500);
      }
    }

    // Función para verificar si el acceso ya fue validado anteriormente
    function isAccessAlreadyValidated() {
      return localStorage.getItem('accessValidated') === 'true';
    }
    // Función para mostrar modal de configuración
    function showSetupModal() {
      document.getElementById('loginModal').style.display = 'none';
      document.getElementById('setupModal').style.display = 'flex';

      // Focus en el campo de nombre
      setTimeout(() => {
        document.getElementById('lenderName').focus();
      }, 300);
    }

    // Función para guardar configuración del prestamista
    function saveLenderConfig() {
      const name = document.getElementById('lenderName').value.trim();
      const phone = document.getElementById('lenderPhone').value.trim();
      const errorDiv = document.getElementById('setupError');

      if (!name) {
        errorDiv.style.display = 'block';
        document.getElementById('lenderName').focus();
        return;
      }

      // Guardar configuración
      const config = {
        name: name,
        phone: phone,
        setupDate: Date.now()
      };

      localStorage.setItem('lenderConfig', JSON.stringify(config));

      // ASEGURAR QUE EL ACCESO QUEDE VALIDADO
      localStorage.setItem('accessValidated', 'true');

      // Cerrar modal y mostrar app
      closeSetupModal();
      updateLenderDisplay();
      initializeApp();

      // Mostrar confirmación
      setTimeout(() => {
        alert(`¡Bienvenido ${name}!\n\nTu configuración ha sido guardada correctamente.`);
      }, 500);
    }
    // Función para obtener configuración del prestamista
    function getLenderConfig() {
      const stored = localStorage.getItem('lenderConfig');
      return stored ? JSON.parse(stored) : { name: '', phone: '' };
    }

    // Función para actualizar el display del prestamista
    function updateLenderDisplay() {
      const config = getLenderConfig();
      if (config.name) {
        // Actualizar el título en el header
        const headerTitle = document.querySelector('h1');
        if (headerTitle) {
          headerTitle.textContent = config.name;
        }
      }
    }

    // Función para cerrar modal de login
    function closeLoginModal() {
      const modal = document.getElementById('loginModal');
      modal.style.opacity = '0';
      setTimeout(() => {
        modal.style.display = 'none';
        modal.style.opacity = '1';
        // *** FORZAR ACTUALIZACIÓN AL CERRAR LOGIN ***
        if (isAppInitialized) {
          refreshAllData();
        }
      }, 300);
    }

    // Función para cerrar modal de configuración
    function closeSetupModal() {
      const modal = document.getElementById('setupModal');
      modal.style.opacity = '0';
      setTimeout(() => {
        modal.style.display = 'none';
        modal.style.opacity = '1';
      }, 300);
    }

    // Event listener para Enter en campos de input
    document.addEventListener('DOMContentLoaded', function () {
      // Enter en campo de código
      document.getElementById('accessCode').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          validateAccess();
        }
      });

      // Enter en campos de configuración
      document.getElementById('lenderName').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          document.getElementById('lenderPhone').focus();
        }
      });

      document.getElementById('lenderPhone').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          saveLenderConfig();
        }
      });

      // *** AGREGAR ESTO: Configurar event listeners después de que todo esté listo ***
      setTimeout(() => {
        setupEventListeners();
      }, 500);
    });

    // Función para formatear montos
    function formatCurrency(amount) {
      return `$${amount.toLocaleString()}`;
    }

    // Inicializar aplicación
    // Inicializar aplicación
    function initializeApp() {
      if (isAppInitialized) return;

      // Actualizar display del prestamista
      updateLenderDisplay();

      // Establecer fecha actual
      const today = new Date();
      const options = {
        weekday: 'long',
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      };
      document.getElementById('currentDate').textContent =
        'Hoy, ' + today.toLocaleDateString('es-ES', options);

      // Cargar datos del localStorage
      loans = getLoansFromStorage();
      payments = getPaymentsFromStorage();

      // *** FORZAR ACTUALIZACIÓN INMEDIATA ***
      updateDashboard();

      // *** ACTUALIZAR DESPUÉS DE UN PEQUEÑO DELAY ***
      setTimeout(() => {
        refreshAllData();
      }, 100);

      isAppInitialized = true;
    }

    function refreshAllData() {
      // Recargar datos desde localStorage
      loans = getLoansFromStorage();
      payments = getPaymentsFromStorage();

      // Actualizar todas las vistas
      updateDashboard();

      // Si hay modales abiertos, actualizarlos también
      const clientsModal = document.getElementById('clientsModal');
      if (!clientsModal.classList.contains('hidden')) {
        loadClientsList();
      }

      const infoModal = document.getElementById('infoModal');
      if (!infoModal.classList.contains('hidden')) {
        loadInfoData();
      }
    }


    // Función para reiniciar configuración del prestamista
    function resetLenderConfig() {
      const config = getLenderConfig();

      if (confirm(`🔄 REINICIAR CONFIGURACIÓN\n\nPrestamista actual: ${config.name || 'No configurado'}\n\n⚠️ Esto requerirá volver a ingresar:\n• Código de acceso\n• Nombre del prestamista\n\n¿Continuar?`)) {
        if (confirm('⚠️ CONFIRMACIÓN FINAL\n\n¿Estás completamente seguro?\n\nEsta acción no se puede deshacer.')) {
          // ELIMINAR TANTO LA CONFIGURACIÓN COMO LA VALIDACIÓN
          localStorage.removeItem('lenderConfig');
          localStorage.removeItem('accessValidated');
          alert('✅ Configuración reiniciada\n\nLa aplicación se reiniciará ahora.');
          setTimeout(() => {
            location.reload();
          }, 1000);
        }
      }
    }
    // Configurar event listeners
    function setupEventListeners() {
      // Event listeners para cálculo en tiempo real
      const calcFields = ['loanAmount', 'interestRate', 'loanTerm', 'paymentFreq', 'loanDate'];
      calcFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('input', updateLoanCalculation);
          field.addEventListener('change', updateLoanCalculation);
        }
      });

      // Event listener para monto de pago
      const paymentAmountField = document.getElementById('paymentAmount');
      if (paymentAmountField) {
        paymentAmountField.addEventListener('input', updatePaymentSummary);
      }
    }
    // Funciones de localStorage
    function saveLoansToStorage(loansData) {
      localStorage.setItem('prestamos', JSON.stringify(loansData));
    }

    function getLoansFromStorage() {
      const stored = localStorage.getItem('prestamos');
      return stored ? JSON.parse(stored) : [];
    }

    function savePaymentsToStorage(paymentsData) {
      localStorage.setItem('pagos', JSON.stringify(paymentsData));
    }

    function getPaymentsFromStorage() {
      const stored = localStorage.getItem('pagos');
      return stored ? JSON.parse(stored) : [];
    }

    function loadData() {
      loans = getLoansFromStorage();
      payments = getPaymentsFromStorage();
    }

    // Funciones del Modal de Nuevo Préstamo
    function openNewLoanModal() {
      const modal = document.getElementById('newLoanModal');
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';

      // Establecer fecha de hoy por defecto
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('loanDate').value = today;

      // Limpiar cálculos
      updateLoanCalculation();

      // Focus en el primer campo
      setTimeout(() => {
        document.getElementById('clientName').focus();
      }, 300);
    }

    function closeNewLoanModal() {
      const modal = document.getElementById('newLoanModal');
      modal.classList.add('hidden');
      document.body.style.overflow = 'auto';
      clearLoanForm();
    }

    function clearLoanForm() {
      document.getElementById('clientName').value = '';
      document.getElementById('clientPhone').value = '';
      document.getElementById('clientId').value = '';
      document.getElementById('clientAddress').value = '';
      document.getElementById('loanAmount').value = '';
      document.getElementById('interestRate').value = '';
      document.getElementById('loanTerm').value = '';
      document.getElementById('paymentFreq').value = '';
      document.getElementById('loanNotes').value = '';
      updateLoanCalculation();
    }

    // Calcular préstamo en tiempo real
    function updateLoanCalculation() {
      const amount = parseFloat(document.getElementById('loanAmount').value) || 0;
      const rate = parseFloat(document.getElementById('interestRate').value) || 0;
      const term = parseInt(document.getElementById('loanTerm').value) || 0;
      const freq = document.getElementById('paymentFreq').value;
      const loanDate = document.getElementById('loanDate').value;

      // Validar que tengamos los datos mínimos
      if (amount === 0 || rate === 0 || term === 0 || !freq) {
        document.getElementById('calcAmount').textContent = '$0';
        document.getElementById('calcTotal').textContent = '$0';
        document.getElementById('calcPayment').textContent = '$0';
        document.getElementById('calcDueDate').textContent = '--';
        return;
      }

      // Calcular interés por período
      let interestPerPeriod = 0;
      let periodsInTerm = 0;

      if (freq === 'diario') {
        interestPerPeriod = (amount * rate) / 100;
        periodsInTerm = term;
      } else if (freq === 'semanal') {
        interestPerPeriod = (amount * rate) / 100;
        periodsInTerm = Math.ceil(term / 7);
      } else if (freq === 'quincenal') {
        interestPerPeriod = (amount * rate) / 100;
        periodsInTerm = Math.ceil(term / 15);
      } else if (freq === 'mensual') {
        interestPerPeriod = (amount * rate) / 100;
        periodsInTerm = Math.ceil(term / 30);
      }

      const totalInterestIfOnlyInterest = interestPerPeriod * periodsInTerm;

      // Calcular fecha de vencimiento
      let dueDate = '--';
      if (loanDate && term > 0) {
        const date = new Date(loanDate);
        date.setDate(date.getDate() + term);
        dueDate = date.toLocaleDateString('es-ES');
      }

      // Actualizar display con valores reales
      document.getElementById('calcAmount').textContent = `$${amount.toLocaleString()}`;
      document.getElementById('calcTotal').textContent = `$${(amount + totalInterestIfOnlyInterest).toLocaleString()}`;
      document.getElementById('calcPayment').textContent = `$${interestPerPeriod.toFixed(2)}`;
      document.getElementById('calcDueDate').textContent = dueDate;
    }
    // Función para enviar datos a Google Forms
    async function enviarAGoogleForm(url, datos) {
      try {
        const formData = new URLSearchParams();

        for (const [key, value] of Object.entries(datos)) {
          formData.append(key, value);
        }

        await fetch(url, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: formData.toString()
        });

        return true;
      } catch (error) {
        console.error('Error al enviar a Google Forms:', error);
        return false;
      }
    }

    // Función para registrar préstamo en Google Forms
   // Función para registrar préstamo en Google Forms
  async function registrarPrestamoEnGoogle(loanData) {
    // Obtener nombre del prestamista
    const lenderConfig = getLenderConfig();
    const nombrePrestamista = lenderConfig.name || 'Prestamista';

    const datos = {
      [FORM_PRESTAMOS_FIELDS.fechaHora]: nombrePrestamista,  // *** CAMBIADO: Ahora envía nombre del prestamista
      [FORM_PRESTAMOS_FIELDS.nombreCliente]: loanData.client.name,
      [FORM_PRESTAMOS_FIELDS.cedula]: loanData.client.id,
      [FORM_PRESTAMOS_FIELDS.telefono]: loanData.client.phone,
      [FORM_PRESTAMOS_FIELDS.direccion]: loanData.client.address,
      [FORM_PRESTAMOS_FIELDS.montoPrestado]: loanData.loan.principal,
      [FORM_PRESTAMOS_FIELDS.tasaInteres]: loanData.loan.rate,
      [FORM_PRESTAMOS_FIELDS.plazo]: loanData.loan.term,
      [FORM_PRESTAMOS_FIELDS.frecuencia]: loanData.loan.frequency,
      [FORM_PRESTAMOS_FIELDS.fechaPrestamo]: loanData.loan.date,
      [FORM_PRESTAMOS_FIELDS.interesPeriodo]: loanData.loan.interestPerPeriod,
      [FORM_PRESTAMOS_FIELDS.observaciones]: loanData.loan.notes,
      [FORM_PRESTAMOS_FIELDS.idPrestamo]: loanData.id
    };

    return await enviarAGoogleForm(FORM_PRESTAMOS_URL, datos);
  }

    // Función para registrar pago en Google Forms
   // Función para registrar pago en Google Forms
  async function registrarPagoEnGoogle(loan, payment) {
    // Obtener nombre del prestamista
    const lenderConfig = getLenderConfig();
    const nombrePrestamista = lenderConfig.name || 'Prestamista';

    const datos = {
      [FORM_PAGOS_FIELDS.fechaHora]: nombrePrestamista,  // *** CAMBIADO: Ahora envía nombre del prestamista
      [FORM_PAGOS_FIELDS.nombreCliente]: loan.client.name,
      [FORM_PAGOS_FIELDS.idPrestamo]: loan.id,
      [FORM_PAGOS_FIELDS.montoPago]: payment.amount,
      [FORM_PAGOS_FIELDS.tipoPago]: payment.type === 'capital' ? 'Capital' : 'Interés',
      [FORM_PAGOS_FIELDS.metodoPago]: payment.method,
      [FORM_PAGOS_FIELDS.notas]: payment.notes,
      [FORM_PAGOS_FIELDS.saldoRestante]: loan.currentBalance,
      [FORM_PAGOS_FIELDS.idPago]: payment.id
    };

    return await enviarAGoogleForm(FORM_PAGOS_URL, datos);
  }
    // Guardar préstamo
    async function saveLoan() {
      // *** NUEVO: Verificar conexión antes de continuar ***
      const tieneConexion = await verificarConexion();

      if (!tieneConexion) {
        alert('❌ SIN CONEXIÓN A INTERNET\n\n⚠️ Debes tener conexión a internet para crear un préstamo.\n\nVerifica tu conexión WiFi o datos móviles e intenta nuevamente.');
        return;
      }

      // Validar campos requeridos
      const requiredFields = {
        clientName: 'Nombre del cliente',
        clientPhone: 'Teléfono',
        clientId: 'Cédula/ID',
        loanAmount: 'Monto del préstamo',
        interestRate: 'Tasa de interés',
        loanTerm: 'Plazo',
        paymentFreq: 'Frecuencia de pago'
      };

      for (const [field, label] of Object.entries(requiredFields)) {
        const value = document.getElementById(field).value.trim();
        if (!value) {
          alert(`Por favor completa el campo: ${label}`);
          document.getElementById(field).focus();
          return;
        }
      }

      // Recopilar datos
      const amount = parseFloat(document.getElementById('loanAmount').value);
      const rate = parseFloat(document.getElementById('interestRate').value);

      // Calcular interés por período
      let interestPerPeriod = 0;
      const freq = document.getElementById('paymentFreq').value;

      if (freq === 'diario') {
        interestPerPeriod = (amount * rate) / 100;
      } else if (freq === 'semanal') {
        interestPerPeriod = (amount * rate) / 100;
      } else if (freq === 'quincenal') {
        interestPerPeriod = (amount * rate) / 100;
      } else if (freq === 'mensual') {
        interestPerPeriod = (amount * rate) / 100;
      }

      currentLoanData = {
        id: Date.now(),
        client: {
          name: document.getElementById('clientName').value.trim(),
          phone: document.getElementById('clientPhone').value.trim(),
          id: document.getElementById('clientId').value.trim(),
          address: document.getElementById('clientAddress').value.trim()
        },
        loan: {
          principal: amount,
          rate: rate,
          interestPerPeriod: interestPerPeriod,
          term: parseInt(document.getElementById('loanTerm').value),
          frequency: freq,
          date: document.getElementById('loanDate').value,
          notes: document.getElementById('loanNotes').value.trim()
        },
        status: 'active',
        createdAt: Date.now(),
        currentBalance: amount,
        accruedInterest: 0,
        payments: []
      };

      // *** Intentar registrar en Google Forms ***
      const registroExitoso = await registrarPrestamoEnGoogle(currentLoanData);

      if (!registroExitoso) {
        alert('❌ ERROR AL REGISTRAR\n\n⚠️ No se pudo guardar el préstamo en Google Drive.\n\nVerifica tu conexión a internet e intenta nuevamente.');
        return;
      }

      // Solo guardar localmente SI se registró exitosamente en Google
      loans.unshift(currentLoanData);
      saveLoansToStorage(loans);

      // Mostrar confirmación
      alert(`✅ Préstamo creado exitosamente!\n\nCliente: ${currentLoanData.client.name}\nCapital prestado: $${amount.toLocaleString()}\nInterés por ${freq}: $${interestPerPeriod.toFixed(2)}\n\n☁️ Registrado en Google Drive`);

      // Actualizar dashboard y cerrar modal
      closeNewLoanModal();
      refreshAllData();
    }
    // Funciones del Dashboard
    function updateDashboard() {
      updateMetrics();
      updateActivity();
      updateNotifications();
    }

    function updateMetrics() {
      let totalLoaned = 0;
      let totalPending = 0;
      let collectedToday = 0;
      let totalInterestCollected = 0;
      let interestPaymentsCount = 0;
      let paymentsCount = 0;
      let totalCapitalRecovered = 0;

      const today = new Date().toDateString();

      loans.forEach(loan => {
        totalLoaned += loan.loan.principal;
        totalPending += loan.currentBalance;
        totalCapitalRecovered += (loan.loan.principal - loan.currentBalance);

        loan.payments.forEach(payment => {
          const paymentDate = new Date(payment.date).toDateString();
          if (paymentDate === today) {
            collectedToday += payment.amount;
            paymentsCount++;
          }

          if (payment.type === 'interes' && payment.amount > 0) {
            totalInterestCollected += payment.amount;
            interestPaymentsCount++;
          }
        });
      });

      // Usar funciones seguras para actualizar
      safeUpdateElement('totalLoaned', formatCurrency(totalLoaned));
      safeUpdateElement('totalPending', formatCurrency(totalPending));
      safeUpdateElement('collectedToday', formatCurrency(collectedToday));
      safeUpdateElement('interestAmount', formatCurrency(totalInterestCollected));
      safeUpdateElement('totalBalance', formatCurrency(totalCapitalRecovered));

      const recoveryPercentage = totalLoaned > 0 ? ((totalCapitalRecovered / totalLoaned) * 100).toFixed(1) : 0;
      safeUpdateElement('balanceChange', `${recoveryPercentage}% recuperado`);

      const percentage = totalLoaned > 0 ? ((collectedToday / totalLoaned) * 100).toFixed(1) : 0;
      safeUpdateElement('totalPercentage', `+${percentage}%`);

      safeUpdateElement('paymentsToday', `${paymentsCount} pagos`);
      safeUpdateElement('interestCount', `${interestPaymentsCount} pagos`);
      safeUpdateElement('pendingCount', loans.filter(l => l.currentBalance > 0).length);
    }
    function updateActivity() {
      const activityList = document.getElementById('activityList');

      if (loans.length === 0) {
        activityList.innerHTML = `
          <div class="text-center text-gray-500 py-8">
            <span class="material-symbols-outlined text-4xl mb-2 block">receipt_long</span>
            <p class="text-sm">No hay actividad reciente</p>
            <p class="text-xs text-gray-400">Crea tu primer préstamo para comenzar</p>
          </div>
        `;
        return;
      }

      // Combinar préstamos y pagos recientes
      let activities = [];

      // Agregar préstamos recientes
      loans.slice(0, 3).forEach(loan => {
        activities.push({
          type: 'loan',
          data: loan,
          timestamp: loan.createdAt
        });
      });

      // Agregar pagos recientes
      loans.forEach(loan => {
        loan.payments.slice(-2).forEach(payment => {
          activities.push({
            type: 'payment',
            data: { ...payment, clientName: loan.client.name },
            timestamp: payment.timestamp
          });
        });
      });

      // Ordenar por timestamp
      activities.sort((a, b) => b.timestamp - a.timestamp);
      activities = activities.slice(0, 5);

      if (activities.length === 0) {
        updateActivity();
        return;
      }

      let html = '';
      activities.forEach(activity => {
        const timeAgo = getTimeAgo(activity.timestamp);

        if (activity.type === 'loan') {
          const loan = activity.data;
          html += `
        <div class="client-item mobile-card bg-white rounded-xl p-4 tap-highlight"
             onclick="if(!isLongPress) openClientDetail('${loan.id}')"
             ontouchstart="handleLongPressStart(this, '${loan.id}')"
             ontouchend="handleLongPressEnd(this)"
             ontouchcancel="handleLongPressEnd(this)"
             onmousedown="handleLongPressStart(this, '${loan.id}')"
             onmouseup="handleLongPressEnd(this)"
             onmouseleave="handleLongPressEnd(this)">
              <div class="flex items-center">
                <div class="bg-red-100 rounded-full p-3 mr-3">
                  <span class="material-symbols-outlined text-red-600">arrow_upward</span>
                </div>
                <div class="flex-1">
                  <p class="text-gray-900 font-semibold">${loan.client.name}</p>
                  <p class="text-gray-500 text-sm">Nuevo préstamo</p>
                  <p class="text-gray-400 text-xs">${timeAgo}</p>
                </div>
                <div class="text-right">
                  <p class="text-red-600 font-bold">-$${loan.loan.principal.toLocaleString()}</p>
                  <span class="material-symbols-outlined text-gray-400">chevron_right</span>
                </div>
              </div>
            </div>
          `;
        } else {
          const payment = activity.data;
          html += `
            <div class="mobile-card bg-white rounded-xl p-4">
              <div class="flex items-center">
                <div class="bg-green-100 rounded-full p-3 mr-3">
                  <span class="material-symbols-outlined text-green-600">arrow_downward</span>
                </div>
                <div class="flex-1">
                  <p class="text-gray-900 font-semibold">${payment.clientName}</p>
                  <p class="text-gray-500 text-sm">Pago recibido</p>
                  <p class="text-gray-400 text-xs">${timeAgo}</p>
                </div>
                <div class="text-green-600 font-bold">+$${payment.amount.toLocaleString()}</div>
              </div>
            </div>
          `;
        }
      });

      activityList.innerHTML = html;
    }

    function updateNotifications() {
      const clientsDue = getClientsWithPaymentsDue();
      const count = clientsDue.length;



      // Guardar los clientes con pagos pendientes para mostrar después
      window.clientsWithPaymentsDue = clientsDue;
    }
    function getClientsWithPaymentsDue() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      let clientsDue = [];

      loans.forEach(loan => {
        if (loan.currentBalance <= 0) return; // Skip paid loans

        const loanDate = new Date(loan.loan.date);
        loanDate.setHours(0, 0, 0, 0);
        const frequency = loan.loan.frequency;
        let daysBetweenPayments;

        // Determinar días entre pagos según frecuencia
        switch (frequency) {
          case 'diario':
            daysBetweenPayments = 1;
            break;
          case 'semanal':
            daysBetweenPayments = 7;
            break;
          case 'quincenal':
            daysBetweenPayments = 15;
            break;
          case 'mensual':
            daysBetweenPayments = 30;
            break;
          default:
            return;
        }

        // Calcular cuántos pagos debería haber hecho hasta hoy
        const daysSinceLoan = Math.floor((today - loanDate) / (1000 * 60 * 60 * 24));

        // Si aún no ha pasado el tiempo para el primer pago, no debe nada hoy
        if (daysSinceLoan < daysBetweenPayments) return;

        const expectedPayments = Math.floor(daysSinceLoan / daysBetweenPayments) + 1;
        const actualPayments = loan.payments.filter(p => p.amount > 0).length;

        // Solo si debe pagos
        if (actualPayments < expectedPayments) {
          // Calcular la fecha exacta del próximo pago que debe
          const nextPaymentDate = new Date(loanDate);
          nextPaymentDate.setDate(nextPaymentDate.getDate() + (actualPayments * daysBetweenPayments));
          nextPaymentDate.setHours(0, 0, 0, 0);

          // SOLO agregar si la fecha de pago es exactamente HOY
          if (nextPaymentDate.getTime() === today.getTime()) {
            clientsDue.push({
              loan: loan,
              client: loan.client,
              daysOverdue: 0, // Siempre será 0 porque solo mostramos los de hoy
              nextPaymentDate: nextPaymentDate,
              expectedAmount: loan.loan.interestPerPeriod,
              frequency: frequency,
              paymentsOwed: expectedPayments - actualPayments
            });
          }
        }
      });

      return clientsDue;
    }
    // Función para calcular tiempo transcurrido
    function getTimeAgo(timestamp) {
      const now = Date.now();
      const diff = now - timestamp;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);

      if (minutes < 1) return 'Hace un momento';
      if (minutes < 60) return `Hace ${minutes} min`;
      if (hours < 24) return `Hace ${hours} hora${hours > 1 ? 's' : ''}`;
      if (days < 7) return `Hace ${days} día${days > 1 ? 's' : ''}`;
      return 'Hace más de una semana';
    }

    // Funciones del Modal de Clientes
    function openClientsModal() {
      const modal = document.getElementById('clientsModal');
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      loadClientsList();
    }

    function closeClientsModal() {
      const modal = document.getElementById('clientsModal');
      modal.classList.add('hidden');
      document.body.style.overflow = 'auto';
      document.getElementById('clientSearch').value = '';
    }

    function loadClientsList() {
      const clientsList = document.getElementById('clientsList');

      if (loans.length === 0) {
        clientsList.innerHTML = `
          <div class="text-center text-gray-500 py-8">
            <span class="material-symbols-outlined text-4xl mb-2 block">group</span>
            <p class="text-sm">No hay clientes registrados</p>
            <p class="text-xs text-gray-400">Crea tu primer préstamo para agregar clientes</p>
          </div>
        `;
        return;
      }

      let html = '';
      loans.forEach(loan => {
        const paymentCount = loan.payments.length;
        const statusColor = loan.currentBalance > 0 ? 'text-orange-600' : 'text-green-600';
        const statusText = loan.currentBalance > 0 ? 'Pendiente' : 'Pagado';
        html += `
      <div class="client-item mobile-card bg-white rounded-xl p-4 tap-highlight"
           onclick="if(!isLongPress) openClientDetail('${loan.id}')"
           ontouchstart="handleLongPressStart(this, '${loan.id}')"
           ontouchend="handleLongPressEnd(this)"
           ontouchcancel="handleLongPressEnd(this)"
           onmousedown="handleLongPressStart(this, '${loan.id}')"
           onmouseup="handleLongPressEnd(this)"
           onmouseleave="handleLongPressEnd(this)">
            <div class="flex items-center justify-between">
              <div class="flex items-center">
                <div class="bg-blue-100 rounded-full p-3 mr-3">
                  <span class="material-symbols-outlined text-blue-600">person</span>
                </div>
                <div>
                  <p class="text-gray-900 font-semibold">${loan.client.name}</p>
                  <p class="text-gray-500 text-sm">${loan.client.phone}</p>
                  <p class="text-gray-400 text-xs">${paymentCount} pagos realizados</p>
                </div>
              </div>
              <div class="text-right">
                <p class="${statusColor} font-bold text-sm">${statusText}</p>
              <p class="text-gray-900 font-semibold">$${loan.currentBalance.toLocaleString()}</p>
                <span class="material-symbols-outlined text-gray-400">chevron_right</span>
              </div>
            </div>
          </div>
        `;
      });

      clientsList.innerHTML = html;
    }

    function filterClients() {
      const searchTerm = document.getElementById('clientSearch').value.toLowerCase();
      const clientItems = document.querySelectorAll('#clientsList .client-item');

      clientItems.forEach(item => {
        const clientName = item.querySelector('.font-semibold').textContent.toLowerCase();
        const clientPhone = item.querySelector('.text-gray-500').textContent.toLowerCase();

        if (clientName.includes(searchTerm) || clientPhone.includes(searchTerm)) {
          item.style.display = 'block';
        } else {
          item.style.display = 'none';
        }
      });
    }

    // Funciones del Modal de Detalle de Cliente
    function openClientDetail(loanId) {
      const loan = loans.find(l => l.id == loanId);
      if (!loan) return;

      currentClientId = loanId;

      // Llenar información del cliente
      document.getElementById('clientDetailName').textContent = loan.client.name;
      document.getElementById('clientDetailPhone').textContent = loan.client.phone;
      document.getElementById('clientDetailId').textContent = loan.client.id;
      document.getElementById('clientDebtTotal').textContent = `$${loan.currentBalance.toLocaleString()}`;
      // Mostrar fecha de creación del préstamo
      const loanDate = new Date(loan.loan.date);
      document.getElementById('loanCreationDate').textContent = loanDate.toLocaleDateString('es-ES');

      // Estado del cliente
      const status = loan.currentBalance > 0 ? 'Debe dinero' : 'Al día';
      const statusColor = loan.currentBalance > 0 ? 'text-red-600' : 'text-green-600';
      document.getElementById('clientStatus').textContent = status;
      document.getElementById('clientStatus').className = `font-semibold ${statusColor}`;

      // Calcular información de cuotas
      const paymentInfo = calculatePaymentAmount(loan);
      document.getElementById('originalAmount').textContent = `$${loan.loan.principal.toLocaleString()}`;
      document.getElementById('paymentFreqText').textContent = paymentInfo.frequency;
      document.getElementById('paymentAmountText').textContent = `$${paymentInfo.amount.toFixed(2)}`;

      // Cargar historial de pagos
      loadPaymentHistory(loan);

      // Cerrar modal de clientes y abrir detalle
      closeClientsModal();
      const modal = document.getElementById('clientDetailModal');
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
    function calculatePaymentAmount(loan) {
      const { interestPerPeriod, frequency } = loan.loan;

      let freqText = '';
      switch (frequency) {
        case 'diario':
          freqText = 'diaria';
          break;
        case 'semanal':
          freqText = 'semanal';
          break;
        case 'quincenal':
          freqText = 'quincenal';
          break;
        case 'mensual':
          freqText = 'mensual';
          break;
        default:
          freqText = 'única';
      }

      return {
        amount: interestPerPeriod,
        frequency: freqText,
        totalPayments: 1
      };
    }

    function closeClientDetailModal() {
      const modal = document.getElementById('clientDetailModal');
      modal.classList.add('hidden');
      document.body.style.overflow = 'auto';
      currentClientId = null;
    }

    function loadPaymentHistory(loan) {
      const historyContainer = document.getElementById('paymentHistory');

      if (loan.payments.length === 0) {
        historyContainer.innerHTML = `
          <div class="text-center text-gray-500 py-4">
            <span class="material-symbols-outlined text-2xl mb-1 block">receipt</span>
            <p class="text-sm">No hay pagos registrados</p>
          </div>
        `;
        return;
      }

      let html = '';
      loan.payments.slice().reverse().forEach(payment => {
        const date = new Date(payment.date);
        const formattedDate = date.toLocaleDateString('es-ES');
        const formattedTime = date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

        // Determinar colores según el monto
        const isZeroPayment = payment.amount === 0;
        const bgColor = isZeroPayment ? 'bg-red-50' : 'bg-green-50';
        const borderColor = isZeroPayment ? 'border-red-400' : 'border-green-400';
        const textColor = isZeroPayment ? 'text-red-800' : 'text-green-800';
        const secondaryColor = isZeroPayment ? 'text-red-600' : 'text-green-600';
        const lightColor = isZeroPayment ? 'text-red-700' : 'text-green-700';
        const badgeColor = isZeroPayment ? 'bg-red-200' : 'bg-green-200';

        html += `
      <div class="${bgColor} rounded-xl p-4 border-l-4 ${borderColor} mb-3">
        <div class="flex justify-between items-start mb-2">
          <span class="font-semibold ${textColor} text-lg">
            ${isZeroPayment ? 'SIN PAGO - $0' : '$' + payment.amount.toLocaleString()}
          </span>
          <span class="${secondaryColor} text-sm font-medium">${payment.type === 'capital' ? 'Capital' : 'Interés'}</span>
        </div>
        <div class="flex justify-between items-center text-sm ${lightColor} mb-1">
          <span class="font-medium">${formattedDate} - ${formattedTime}</span>
          <span class="${badgeColor} px-2 py-1 rounded text-xs">${payment.method}</span>
        </div>
        ${payment.notes ? `<p class="text-sm ${secondaryColor} mt-2 italic">${payment.notes}</p>` : ''}
        ${isZeroPayment ? `<p class="text-sm ${secondaryColor} mt-1 font-medium">⚠️ No realizó pago en esta fecha</p>` : ''}
      </div>
    `;
      });

      historyContainer.innerHTML = html;
    }

    function callClient() {
      const loan = loans.find(l => l.id == currentClientId);
      if (loan) {
        window.location.href = `tel:${loan.client.phone}`;
      }
    }

    // Funciones del Modal de Pagos
    function openPaymentModal() {
      const loan = loans.find(l => l.id == currentClientId);
      if (!loan) return;

      document.getElementById('paymentClientName').textContent = loan.client.name;
      document.getElementById('paymentAmount').value = '';
      document.getElementById('paymentType').value = 'cuota';
      document.getElementById('paymentMethod').value = 'efectivo';
      document.getElementById('paymentNotes').value = '';

      updatePaymentSummary();

      const modal = document.getElementById('paymentModal');
      modal.classList.remove('hidden');
    }

    function closePaymentModal() {
      const modal = document.getElementById('paymentModal');
      modal.classList.add('hidden');
    }

    function updatePaymentSummary() {
      const amount = parseFloat(document.getElementById('paymentAmount').value) || 0;
      const paymentType = document.getElementById('paymentType').value;
      const loan = loans.find(l => l.id == currentClientId);

      if (loan) {
        let remaining;
        if (paymentType === 'capital') {
          remaining = Math.max(0, loan.currentBalance - amount);
        } else {
          remaining = loan.currentBalance; // Pago de interés no reduce el capital
        }

        document.getElementById('summaryAmount').textContent = `$${amount.toLocaleString()}`;
        document.getElementById('summaryRemaining').textContent = `$${remaining.toLocaleString()}`;
      }
    }

    async function savePayment() {
      // *** NUEVO: Verificar conexión antes de continuar ***
      const tieneConexion = await verificarConexion();

      if (!tieneConexion) {
        alert('❌ SIN CONEXIÓN A INTERNET\n\n⚠️ Debes tener conexión a internet para registrar un pago.\n\nVerifica tu conexión WiFi o datos móviles e intenta nuevamente.');
        return;
      }

      const amount = parseFloat(document.getElementById('paymentAmount').value);
      const paymentType = document.getElementById('paymentType').value;

      if (amount === null || amount === undefined || amount < 0) {
        alert('Por favor ingresa un monto válido');
        return;
      }

      const loan = loans.find(l => l.id == currentClientId);
      if (!loan) return;

      // Validar según el tipo de pago
      if (paymentType === 'capital' && amount > loan.currentBalance) {
        if (!confirm(`El monto ($${amount.toLocaleString()}) es mayor al capital adeudado ($${loan.currentBalance.toLocaleString()}). ¿Continuar?`)) {
          return;
        }
      }

      const payment = {
        id: Date.now(),
        amount: amount,
        type: paymentType,
        method: document.getElementById('paymentMethod').value,
        notes: document.getElementById('paymentNotes').value.trim(),
        date: Date.now(),
        timestamp: Date.now()
      };

      // Guardar balance anterior para poder revertir si falla
      const balanceAnterior = loan.currentBalance;

      // Procesar pago según tipo (solo si es mayor a 0)
      if (amount > 0 && paymentType === 'capital') {
        loan.currentBalance = Math.max(0, loan.currentBalance - amount);
      }

      // Si se pagó todo el capital, marcar como completado
      if (loan.currentBalance === 0) {
        loan.status = 'completed';
      }

      // *** Intentar registrar en Google Forms ***
      const registroExitoso = await registrarPagoEnGoogle(loan, payment);

      if (!registroExitoso) {
        // Revertir cambios si falló el registro
        loan.currentBalance = balanceAnterior;
        if (balanceAnterior > 0) {
          loan.status = 'active';
        }

        alert('❌ ERROR AL REGISTRAR PAGO\n\n⚠️ No se pudo guardar el pago en Google Drive.\n\nVerifica tu conexión a internet e intenta nuevamente.');
        return;
      }

      // Solo guardar localmente y agregar al historial SI se registró exitosamente
      loan.payments.push(payment);
      saveLoansToStorage(loans);

      let resultMessage;
      if (amount === 0) {
        resultMessage = `📝 Registro sin pago guardado!\n\nFecha: ${new Date().toLocaleDateString('es-ES')}\nMotivo: Cliente no pagó\nDeuda sigue siendo: $${loan.currentBalance.toLocaleString()}`;
      } else if (paymentType === 'capital') {
        resultMessage = `✅ Pago a capital registrado!\n\nMonto: $${amount.toLocaleString()}\nDeuda restante: $${loan.currentBalance.toLocaleString()}`;
      } else {
        resultMessage = `✅ Pago de interés registrado!\n\nMonto: $${amount.toLocaleString()}\nCapital sigue siendo: $${loan.currentBalance.toLocaleString()}`;
      }

      resultMessage += '\n\n☁️ Registrado en Google Drive';

      alert(resultMessage);

      // Actualizar vistas
      refreshAllData();
      loadPaymentHistory(loan);

      // Actualizar info del cliente en el modal
      document.getElementById('clientDebtTotal').textContent = `$${loan.currentBalance.toLocaleString()}`;
      const status = loan.currentBalance > 0 ? 'Debe dinero' : 'Al día';
      const statusColor = loan.currentBalance > 0 ? 'text-red-600' : 'text-green-600';
      document.getElementById('clientStatus').textContent = status;
      document.getElementById('clientStatus').className = `font-semibold ${statusColor}`;

      closePaymentModal();
    }
    // Generar recibo como imagen
    function generateReceipt() {
      const loan = loans.find(l => l.id == currentClientId);
      if (!loan) return;

      createReceiptImage(loan);
    }

    function createReceiptImage(loan) {
      // Crear canvas optimizado para móviles (altura dinámica según cantidad de pagos)
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      // Calcular altura dinámica basada en cantidad de pagos
      const scale = 2;
      const baseHeight = 800; // Altura base sin pagos
      const paymentRowHeight = 35; // Altura por cada pago
      const totalPayments = loan.payments.length;
      const dynamicHeight = baseHeight + (totalPayments * paymentRowHeight);

      canvas.width = 750 * scale;
      canvas.height = dynamicHeight * scale;

      // Fondo blanco
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Configuración de fuentes y colores
      const primaryColor = '#1f2937';
      const secondaryColor = '#6b7280';
      const accentColor = '#3b82f6';

      let y = 40 * scale;

      // Header con título
      ctx.fillStyle = accentColor;
      ctx.fillRect(0, 0, canvas.width, 120 * scale);

      ctx.fillStyle = '#ffffff';
      ctx.font = `bold ${28 * scale}px Arial`;
      ctx.textAlign = 'center';
      ctx.fillText('RECIBO DE PRÉSTAMO', canvas.width / 2, 35 * scale);

      const appTitle = document.querySelector('h1').textContent || 'Mi Panel';
      ctx.font = `bold ${18 * scale}px Arial`;
      ctx.fillText(`Prestamista: ${appTitle}`, canvas.width / 2, 60 * scale);

      ctx.font = `${16 * scale}px Arial`;
      const currentDate = new Date().toLocaleDateString('es-ES');
      const currentTime = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
      ctx.fillText(`${currentDate} - ${currentTime}`, canvas.width / 2, 85 * scale);

      y = 140 * scale;

      // Función helper para texto
      function addText(text, fontSize = 16, color = primaryColor, bold = false, align = 'left') {
        ctx.fillStyle = color;
        ctx.font = `${bold ? 'bold ' : ''}${fontSize * scale}px Arial`;
        ctx.textAlign = align;
        const margin = 40 * scale;
        ctx.fillText(text, align === 'center' ? canvas.width / 2 : margin, y);
        y += (fontSize + 8) * scale;
      }

      function addSection(title) {
        y += 10 * scale;
        ctx.fillStyle = '#f3f4f6';
        ctx.fillRect(20 * scale, y - 25 * scale, canvas.width - 40 * scale, 35 * scale);

        ctx.fillStyle = primaryColor;
        ctx.font = `bold ${18 * scale}px Arial`;
        ctx.textAlign = 'left';
        ctx.fillText(title, 30 * scale, y - 5 * scale);
        y += 20 * scale;
      }

      // Datos del Cliente
      addSection('DATOS DEL CLIENTE');
      addText(`Nombre: ${loan.client.name}`, 16, primaryColor, true);
      addText(`Teléfono: ${loan.client.phone}`, 15);
      addText(`Cédula: ${loan.client.id}`, 15);

      if (loan.client.address && loan.client.address.trim()) {
        const address = loan.client.address;
        if (address.length > 40) {
          const words = address.split(' ');
          let line1 = '';
          let line2 = '';

          words.forEach(word => {
            if (line1.length + word.length <= 40) {
              line1 += (line1 ? ' ' : '') + word;
            } else {
              line2 += (line2 ? ' ' : '') + word;
            }
          });

          addText(`Dirección: ${line1}`, 15);
          if (line2) addText(`${line2}`, 15);
        } else {
          addText(`Dirección: ${address}`, 15);
        }
      }

      // Datos del Préstamo
      addSection('DATOS DEL PRÉSTAMO');
      addText(`Capital Original: $${loan.loan.principal.toLocaleString()}`, 17, primaryColor, true);
      addText(`Tasa: ${loan.loan.rate}% ${loan.loan.frequency}`, 15);
      addText(`Fecha: ${new Date(loan.loan.date).toLocaleDateString('es-ES')}`, 15);
      addText(`Plazo: ${loan.loan.term} días`, 15);
      addText(`Saldo Actual: $${loan.currentBalance.toLocaleString()}`, 17, loan.currentBalance > 0 ? '#dc2626' : '#059669', true);

      // Historial de Pagos
      addSection('HISTORIAL DE PAGOS');

      if (loan.payments.length === 0) {
        addText('No hay pagos registrados', 14, secondaryColor);
      } else {
        // Headers de tabla
        ctx.fillStyle = '#e5e7eb';
        ctx.fillRect(20 * scale, y, canvas.width - 40 * scale, 30 * scale);

        ctx.fillStyle = primaryColor;
        ctx.font = `bold ${14 * scale}px Arial`;
        ctx.textAlign = 'left';
        ctx.fillText('FECHA', 30 * scale, y + 20 * scale);
        ctx.fillText('MONTO', 180 * scale, y + 20 * scale);
        ctx.fillText('TIPO', 300 * scale, y + 20 * scale);
        ctx.fillText('MÉTODO', 400 * scale, y + 20 * scale);

        y += 35 * scale;

        // MOSTRAR TODOS LOS PAGOS (sin límite)
        loan.payments.forEach((payment, index) => {
          const paymentDate = new Date(payment.date);
          const bgColor = index % 2 === 0 ? '#f9fafb' : '#ffffff';

          ctx.fillStyle = bgColor;
          ctx.fillRect(20 * scale, y - 15 * scale, canvas.width - 40 * scale, 30 * scale);

          ctx.fillStyle = primaryColor;
          ctx.font = `${14 * scale}px Arial`;
          ctx.textAlign = 'left';

          // Fecha
          const shortDate = paymentDate.toLocaleDateString('es-ES', {
            day: '2-digit',
            month: '2-digit',
            year: '2-digit'
          });
          ctx.fillText(shortDate, 30 * scale, y);

          // Monto con color especial para pagos $0
          const amount = payment.amount === 0 ? '$0' : `$${payment.amount.toLocaleString()}`;
          const amountColor = payment.amount === 0 ? '#dc2626' : primaryColor;
          ctx.fillStyle = amountColor;
          ctx.fillText(amount, 180 * scale, y);

          // Restaurar color y continuar
          ctx.fillStyle = primaryColor;

          // Tipo
          ctx.fillText(payment.type === 'capital' ? 'Capital' : 'Interés', 300 * scale, y);

          // Método
          ctx.fillText(payment.method, 400 * scale, y);

          y += 30 * scale;
        });
      }

      // Resumen
      y += 10 * scale;
      addSection('RESUMEN');
      const totalPaid = loan.payments.reduce((sum, p) => sum + p.amount, 0);
      addText(`Total Pagado: $${totalPaid.toLocaleString()}`, 17, primaryColor, true);
      addText(`Saldo Pendiente: $${loan.currentBalance.toLocaleString()}`, 17, loan.currentBalance > 0 ? '#dc2626' : '#059669', true);
      addText(`Estado: ${loan.currentBalance === 0 ? 'CANCELADO' : 'VIGENTE'}`, 16, loan.currentBalance === 0 ? '#059669' : '#f59e0b', true);

      // Footer
      y += 20 * scale;
      ctx.fillStyle = '#e5e7eb';
      ctx.fillRect(0, y, canvas.width, 60 * scale);

      ctx.fillStyle = secondaryColor;
      ctx.font = `${14 * scale}px Arial`;
      ctx.textAlign = 'center';
      ctx.fillText('Generado por MiPréstamo App', canvas.width / 2, y + 25 * scale);
      ctx.font = `${12 * scale}px Arial`;
      ctx.fillText(`ID: ${loan.id} | Total de pagos: ${loan.payments.length}`, canvas.width / 2, y + 45 * scale);

      // Convertir a blob y compartir
      canvas.toBlob(function (blob) {
        shareReceiptImage(blob, loan);
      }, 'image/png');
    }



    // Funciones para long press (eliminar registros)
    function handleLongPressStart(element, loanId) {
      isLongPress = false;
      element.classList.add('long-press');

      longPressTimer = setTimeout(() => {
        isLongPress = true;
        element.classList.add('delete-confirm');
        confirmDeleteLoan(loanId);
      }, 1000); // 1 segundo de press
    }

    function handleLongPressEnd(element) {
      clearTimeout(longPressTimer);
      element.classList.remove('long-press');
      element.classList.remove('delete-confirm');
    }

    function confirmDeleteLoan(loanId) {
      const loan = loans.find(l => l.id == loanId);
      if (!loan) return;

      const totalPaid = loan.payments.reduce((sum, payment) => sum + payment.amount, 0);
      const hasPayments = loan.payments.length > 0;

      let message = `¿Eliminar el préstamo de ${loan.client.name}?\n\n`;
      message += `Monto original: $${loan.loan.principal.toLocaleString()}\n`;
      message += `Deuda actual: $${loan.currentBalance.toLocaleString()}\n`;

      if (hasPayments) {
        message += `Pagos realizados: ${loan.payments.length}\n`;
        message += `Total pagado: $${totalPaid.toLocaleString()}\n\n`;
        message += `⚠️ ATENCIÓN: Este préstamo tiene pagos registrados.\n`;
        message += `Al eliminarlo se perderá todo el historial.`;
      }

      if (confirm(message)) {
        deleteLoan(loanId);
      }
    }

    function deleteLoan(loanId) {
      // Eliminar el préstamo del array
      loans = loans.filter(l => l.id != loanId);

      // Guardar cambios en localStorage
      saveLoansToStorage(loans);

      // Actualizar vistas
      updateDashboard();

      // Cerrar modales si están abiertos
      if (currentClientId == loanId) {
        closeClientDetailModal();
        currentClientId = null;
      }

      // Recargar lista de clientes si está abierta
      const clientsModal = document.getElementById('clientsModal');
      if (!clientsModal.classList.contains('hidden')) {
        loadClientsList();
      }

      alert('✅ Préstamo eliminado correctamente');
    }

    // Funciones adicionales
    function openPaymentsModal() {
      alert('Módulo de pagos del día (próximamente)');
    }

    function viewAllActivity() {
      alert('Vista completa de actividad (próximamente)');
    }

    function viewDetail(type) {
      const messages = {
        'balance': 'Capital recuperado: Suma de todos los abonos a capital realizados por tus clientes',
        'total': 'Desglose de préstamos totales',
        'pending': 'Lista de pagos pendientes',
        'collected': 'Pagos cobrados hoy',
        'interest': 'Total de intereses cobrados - Tu ganancia'
      };
      alert(messages[type] || 'Función en desarrollo');
    }

    function toggleMenu() {
      createGlobalReportImage();
    }

    function createGlobalReportImage() {
      const loans = getLoansFromStorage();

      if (loans.length === 0) {
        alert('No hay préstamos para generar reporte');
        return;
      }

      // Crear canvas con escala Full HD
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      // Configurar escala Full HD
      const scale = 2;
      const baseHeight = 600;
      const loanHeight = 120; // Altura por préstamo SIN escalar
      canvas.width = 800 * scale;
      canvas.height = (baseHeight + (loans.length * loanHeight)) * scale;

      // Fondo blanco
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      const primaryColor = '#1f2937';
      const secondaryColor = '#6b7280';
      const accentColor = '#3b82f6';

      let y = 40 * scale;

      // Header principal (escalado)
      ctx.fillStyle = accentColor;
      ctx.fillRect(0, 0, canvas.width, 120 * scale);

      ctx.fillStyle = '#ffffff';
      ctx.font = `bold ${28 * scale}px Arial`;
      ctx.textAlign = 'center';
      ctx.fillText('REPORTE GLOBAL DE PRÉSTAMOS', canvas.width / 2, 35 * scale);

      // Obtener el título de la app desde el HTML
      const appTitle = document.querySelector('h1').textContent || 'Mi Panel';
      ctx.font = `bold ${18 * scale}px Arial`;
      ctx.fillText(`Prestamista: ${appTitle}`, canvas.width / 2, 60 * scale);

      ctx.font = `${16 * scale}px Arial`;
      const currentDate = new Date().toLocaleDateString('es-ES');
      ctx.fillText(`Fecha: ${currentDate}`, canvas.width / 2, 85 * scale);

      // Resumen general
      y = 150 * scale;
      const totalLoaned = loans.reduce((sum, loan) => sum + loan.loan.principal, 0);
      const totalPending = loans.reduce((sum, loan) => sum + loan.currentBalance, 0);
      const totalPaid = loans.reduce((sum, loan) => sum + loan.payments.reduce((pSum, p) => pSum + p.amount, 0), 0);

      ctx.fillStyle = '#f3f4f6';
      ctx.fillRect(40 * scale, y - 10 * scale, canvas.width - 80 * scale, 80 * scale);

      ctx.fillStyle = primaryColor;
      ctx.font = `bold ${18 * scale}px Arial`;
      ctx.textAlign = 'left';
      ctx.fillText('RESUMEN GENERAL', 60 * scale, y + 15 * scale);

      ctx.font = `${14 * scale}px Arial`;
      ctx.fillText(`Total de préstamos: ${loans.length}`, 60 * scale, y + 35 * scale);
      ctx.fillText(`Capital prestado: $${totalLoaned.toLocaleString()}`, 60 * scale, y + 50 * scale);

      ctx.textAlign = 'right';
      ctx.fillText(`Total pagado: $${totalPaid.toLocaleString()}`, canvas.width - 60 * scale, y + 35 * scale);
      ctx.fillText(`Saldo pendiente: $${totalPending.toLocaleString()}`, canvas.width - 60 * scale, y + 50 * scale);

      y += 100 * scale;

      // Lista de préstamos
      ctx.fillStyle = primaryColor;
      ctx.font = `bold ${20 * scale}px Arial`;
      ctx.textAlign = 'center';
      ctx.fillText('DETALLE POR CLIENTE', canvas.width / 2, y);
      y += 40 * scale;

      loans.forEach((loan, index) => {
        const loanTotalPaid = loan.payments.reduce((sum, p) => sum + p.amount, 0);

        // Fondo alternado (escalado)
        ctx.fillStyle = index % 2 === 0 ? '#f9fafb' : '#ffffff';
        ctx.fillRect(40 * scale, y - 10 * scale, canvas.width - 80 * scale, 100 * scale);

        // Borde izquierdo de color (escalado)
        const statusColor = loan.currentBalance === 0 ? '#059669' : '#dc2626';
        ctx.fillStyle = statusColor;
        ctx.fillRect(40 * scale, y - 10 * scale, 6 * scale, 100 * scale);

        // Información del cliente (escalada)
        ctx.fillStyle = primaryColor;
        ctx.font = `bold ${16 * scale}px Arial`;
        ctx.textAlign = 'left';
        ctx.fillText(`${index + 1}. ${loan.client.name}`, 60 * scale, y + 10 * scale);

        ctx.font = `${12 * scale}px Arial`;
        ctx.fillStyle = secondaryColor;
        ctx.fillText(`Tel: ${loan.client.phone} | Cédula: ${loan.client.id}`, 60 * scale, y + 25 * scale);

        // Datos financieros (escalados)
        ctx.fillStyle = primaryColor;
        ctx.font = `${14 * scale}px Arial`;
        ctx.fillText(`Capital: $${loan.loan.principal.toLocaleString()}`, 60 * scale, y + 45 * scale);
        ctx.fillText(`Pagado: $${loanTotalPaid.toLocaleString()}`, 60 * scale, y + 60 * scale);
        ctx.fillText(`Saldo: $${loan.currentBalance.toLocaleString()}`, 60 * scale, y + 75 * scale);

        // Estado y fecha (escalados)
        ctx.textAlign = 'right';
        ctx.fillStyle = statusColor;
        ctx.font = `bold ${14 * scale}px Arial`;
        ctx.fillText(loan.currentBalance === 0 ? 'CANCELADO' : 'VIGENTE', canvas.width - 60 * scale, y + 15 * scale);

        ctx.fillStyle = secondaryColor;
        ctx.font = `${12 * scale}px Arial`;
        ctx.fillText(`Fecha: ${new Date(loan.loan.date).toLocaleDateString('es-ES')}`, canvas.width - 60 * scale, y + 35 * scale);
        ctx.fillText(`Pagos realizados: ${loan.payments.length}`, canvas.width - 60 * scale, y + 50 * scale);
        ctx.fillText(`Interés: ${loan.loan.rate}% ${loan.loan.frequency}`, canvas.width - 60 * scale, y + 65 * scale);

        y += 120 * scale;
      });

      // Footer (escalado)
      y += 20 * scale;
      ctx.fillStyle = '#e5e7eb';
      ctx.fillRect(0, y, canvas.width, 60 * scale);

      ctx.fillStyle = secondaryColor;
      ctx.font = `${14 * scale}px Arial`;
      ctx.textAlign = 'center';
      ctx.fillText('Generado automáticamente por MiPréstamo App', canvas.width / 2, y + 25 * scale);
      ctx.fillText(`Total de registros: ${loans.length} | Generado: ${new Date().toLocaleString('es-ES')}`, canvas.width / 2, y + 45 * scale);

      // Convertir a blob y compartir
      canvas.toBlob(function (blob) {
        shareGlobalReport(blob);
      }, 'image/png');
    }
    function shareReceiptImage(blob, loan) {
      const reader = new FileReader();
      reader.onload = function () {
        const base64Data = reader.result;
        const fileName = `Recibo_${loan.client.name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}`;
        const message = `📄 Recibo de Préstamo - ${loan.client.name}\n💰 Capital: $${loan.loan.principal.toLocaleString()}\n💳 Saldo: $${loan.currentBalance.toLocaleString()}\n📅 ${new Date().toLocaleDateString('es-ES')}\n\nGenerado por MiPréstamo App`;

        // Mostrar opciones
        if (confirm('¿Cómo deseas compartir el recibo?\n\n✅ OK = WhatsApp directo\n❌ Cancelar = Selector de apps')) {
          // Compartir directo a WhatsApp
          Android.shareToWhatsApp(base64Data, fileName, message);
        } else {
          // Mostrar selector de apps
          Android.shareImage(base64Data, fileName, message);
        }
      };
      reader.readAsDataURL(blob);
    }

    function shareGlobalReport(blob) {
      const loans = getLoansFromStorage();
      const totalLoaned = loans.reduce((sum, loan) => sum + loan.loan.principal, 0);
      const totalPending = loans.reduce((sum, loan) => sum + loan.currentBalance, 0);

      const reader = new FileReader();
      reader.onload = function () {
        const base64Data = reader.result;
        const fileName = `Reporte_Global_${new Date().toISOString().split('T')[0]}`;
        const message = `📊 Reporte Global de Préstamos\n📅 ${new Date().toLocaleDateString('es-ES')}\n💰 Total prestado: $${totalLoaned.toLocaleString()}\n💳 Saldo pendiente: $${totalPending.toLocaleString()}\n📈 Préstamos: ${loans.length}\n\nGenerado por MiPréstamo App`;

        if (confirm('¿Cómo deseas compartir el reporte?\n\n✅ OK = WhatsApp directo\n❌ Cancelar = Selector de apps')) {
          Android.shareToWhatsApp(base64Data, fileName, message);
        } else {
          Android.shareImage(base64Data, fileName, message);
        }
      };
      reader.readAsDataURL(blob);
    }

    function toggleNotifications() {
      // En lugar de mostrar el modal, mostrar alert simple
      const clientsDue = window.clientsWithPaymentsDue || [];

      if (clientsDue.length === 0) {
        alert('🟢 ¡Perfecto!\n\nNo tienes clientes que deban pagar hoy.');
        return;
      }

      // Mostrar lista en alert
      let message = '🔔 CLIENTES QUE DEBEN PAGAR HOY:\n\n';
      clientsDue.forEach((client, index) => {
        message += `${index + 1}. ${client.client.name}\n`;
        message += `   Tel: ${client.client.phone}\n`;
        message += `   Monto: $${client.expectedAmount.toFixed(2)}\n`;
        message += `   Frecuencia: ${client.frequency}\n\n`;
      });

      alert(message);
    }

    function safeUpdateElement(elementId, value) {
      const element = document.getElementById(elementId);
      if (element) {
        element.textContent = value;
      } else {
        console.warn(`Elemento ${elementId} no encontrado`);
      }
    }



    function openInfoModal() {
      const modal = document.getElementById('infoModal');
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      loadInfoData();
    }

    function closeInfoModal() {
      const modal = document.getElementById('infoModal');
      modal.classList.add('hidden');
      document.body.style.overflow = 'auto';
    }

    function loadInfoData() {
      // Contadores por frecuencia
      let dailyCount = 0;
      let weeklyCount = 0;
      let biweeklyCount = 0;
      let monthlyCount = 0;

      // Estadísticas generales
      let totalLoans = loans.length;
      let activeLoans = 0;
      let completedLoans = 0;
      let totalRates = 0;

      // Tasas de interés únicas
      let interestRates = {};

      loans.forEach(loan => {
        const { frequency, rate } = loan.loan;
        const isActive = loan.currentBalance > 0;

        // Contar por frecuencia (solo activos)
        if (isActive) {
          activeLoans++;
          switch (frequency) {
            case 'diario':
              dailyCount++;
              break;
            case 'semanal':
              weeklyCount++;
              break;
            case 'quincenal':
              biweeklyCount++;
              break;
            case 'mensual':
              monthlyCount++;
              break;
          }
        } else {
          completedLoans++;
        }

        // Recopilar tasas de interés
        const rateKey = `${rate}% ${frequency}`;
        if (!interestRates[rateKey]) {
          interestRates[rateKey] = {
            rate: rate,
            frequency: frequency,
            count: 0,
            active: 0
          };
        }
        interestRates[rateKey].count++;
        if (isActive) {
          interestRates[rateKey].active++;
        }

        totalRates += rate;
      });

      // Actualizar contadores por frecuencia
      document.getElementById('dailyInfo').querySelector('.text-xl').textContent = dailyCount;
      document.getElementById('weeklyInfo').querySelector('.text-xl').textContent = weeklyCount;
      document.getElementById('biweeklyInfo').querySelector('.text-xl').textContent = biweeklyCount;
      document.getElementById('monthlyInfo').querySelector('.text-xl').textContent = monthlyCount;

      // Actualizar estadísticas generales
      document.getElementById('totalLoansCount').textContent = totalLoans;
      document.getElementById('activeLoansInfo').textContent = activeLoans;
      document.getElementById('completedLoansInfo').textContent = completedLoans;

      const averageRate = totalLoans > 0 ? (totalRates / totalLoans).toFixed(1) : 0;
      document.getElementById('averageRateInfo').textContent = `${averageRate}%`;

      // Mostrar tasas de interés
      const ratesList = document.getElementById('interestRatesList');
      let ratesHtml = '';

      Object.values(interestRates).forEach(rateInfo => {
        const frequencyText = {
          'diario': 'Diario',
          'semanal': 'Semanal',
          'quincenal': 'Quincenal',
          'mensual': 'Mensual'
        }[rateInfo.frequency] || rateInfo.frequency;

        ratesHtml += `
          <div class="bg-white rounded-lg p-3 border border-gray-200">
            <div class="flex justify-between items-center">
              <div>
                <p class="font-semibold text-gray-900">${rateInfo.rate}% ${frequencyText}</p>
                <p class="text-sm text-gray-600">${rateInfo.active} activos de ${rateInfo.count} total</p>
              </div>
              <div class="text-right">
                <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-medium">
                  ${rateInfo.rate}%
                </span>
              </div>
            </div>
          </div>
        `;
      });

      if (ratesHtml === '') {
        ratesHtml = '<p class="text-gray-500 text-center py-4">No hay préstamos registrados</p>';
      }

      ratesList.innerHTML = ratesHtml;
    }

    function shareToWhatsApp(clientName) {
      const message = `📄 Recibo de préstamo para ${clientName}\n\nGenerado por MiPréstamo App`;
      const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
      window.open(whatsappUrl, '_blank');
    }

    function shareToWhatsAppReport() {
      const message = `📊 Reporte Global de Préstamos\n\nGenerado por MiPréstamo App`;
      const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
      window.open(whatsappUrl, '_blank');
    }



    // Cerrar al tocar el overlay
    document.addEventListener('click', function (e) {
      if (e.target.id === 'imagePreviewOverlay') {
        closeImagePreview();
      }
    });

    // Eliminar la función anterior si existe
    function openPaymentsModal() {
      openProjectionsModal();
    }


    function setActiveTab(tab) {
      // Cambiar tabs activos visualmente
      const tabs = document.querySelectorAll('.sticky.bottom-0 button');
      tabs.forEach(tabButton => {
        tabButton.classList.remove('text-blue-600');
        tabButton.classList.add('text-gray-500');
      });

      event.currentTarget.classList.remove('text-gray-500');
      event.currentTarget.classList.add('text-blue-600');
    }

    // Prevenir zoom en móviles
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
      const now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);

    // Forzar actualización cada vez que se enfoca la ventana
    window.addEventListener('focus', function () {
      if (isAppInitialized) {
        refreshAllData();
      }
    });

    // Auto-actualizar cada 30 segundos
    setInterval(() => {
      if (isAppInitialized) {
        updateDashboard();
      }
    }, 30000);


</script>
</body>

</html>
